---
title: "Oceanic_pH"
author: "phoebe.woodworth-jefcoats@noaa.gov"
format:
  docx:
    reference-doc: SAFE-Reference-Doc.docx
---

## Oceanic pH at Station ALOHA

```{r}
#| include: false
### Load libraries
library(tidyverse)
library(lubridate)
library(here)
library(stringr)
# remotes::install_github("nmfs-fish-tools/nmfspalette")
library(nmfspalette)
```

```{r}
#| include: false
# Set report year (RptYr), to make things easier
# Note that there's a one year lag for HOTS data
RptYr <- 2022

# Set path to variable: Atmospheric_CO2
# This is where the data are and where the plots will go
Dir <- here("Oceanic_pH")
```

```{r}
#| include: false
### Load data
# Monthly(ish) pH is in the 8th column of this file generated by Matlab
pH_full <- read_delim(file = paste(Dir, '/pH_', RptYr, '.dat', sep = ""), col_names = FALSE)
# And dates are in this file
pH_dates <- read_csv(file = paste(Dir, '/TA_DIC_', RptYr, '_withDate.csv', sep = ""))
```

```{r}
#| include: false
### Remove erroneous outliers
pH <- pH_full$X8
outlier <- which(pH < 8)
pH[outlier] <- NA
```

```{r}
#| include: false
### Linear fit 
# Note that this assumes that observations are equally spaced in time, which they're  not
n_obs <- seq(1, length(pH), 1)
pH_lm <- lm(pH ~ n_obs)

# There are a few NA values, so we'll calculate new fitted values for the full number of dates.
# This is just to make plotting easier.
pH_lm_fit <- n_obs*pH_lm$coefficients[2] + pH_lm$coefficients[1]

# Change over time, keeping in mind that pH is a logrithmic scale
delta_pH_lm <- pH_lm_fit[length(n_obs)] - pH_lm_fit[1]
delta_pH_pct = (10^-pH_lm_fit[length(n_obs)] - 10^-pH_lm_fit[1])/10^-pH_lm_fit[1]*100
```

```{r}
#| include: false
### Annual values
yrs <- year(mdy(pH_dates$`date mmddyy`))
pH_dates <- bind_cols(pH_dates, yrs, pH)
pH_dates <- rename(pH_dates, Year = ...6)
pH_dates <- rename(pH_dates, pH = ...7)

ann_pH <- pH_dates %>%
  group_by(Year) %>%
  summarise(pH = mean(pH, na.rm = TRUE))
ann_mean_RptYr <- ann_pH$pH[which(ann_pH$Year == RptYr - 1)]

# Find years when the highest value is lower than the lowest value in the first year
ann_pHmin <- pH_dates %>%
  group_by(Year) %>%
  summarise(min_pH = min(pH, na.rm = TRUE))
yr1_min <- ann_pHmin$min_pH[1]

ann_pHmax <- pH_dates %>%
  group_by(Year) %>%
  summarise(max_pH = max(pH, na.rm = TRUE))
yrs_below <- ann_pHmax$Year[which(ann_pHmax$max_pH < yr1_min)]
n_yrs_below <- length(yrs_below)
ann_max_RptYr <- ann_pHmax$max_pH[which(ann_pHmax$Year == RptYr - 1)]
```

```{r}
#| echo: false
# Note that the above needs to be 'echo' and not 'include' so that the error checks print.

# This section includes some error checks to prompt fixing the text
if (any(summary(pH_lm)$coefficients[,4] > 0.05)) {
  print('The linear fit is not signficant. Remove text related to the linear trend.')
}

n_txt <- as.numeric(str_extract(n_yrs_below, "\\d$"))
if (n_txt > 0 & n_txt < 4) {
  print('Edit the text around the number of years that pH has been outside the range seen the first year.')
}

```

```{r}
#| include: false
### Create plot for report
# Create a vector that repeats the annual mean the same number of times as there are obs for the latest year
# (although there are other ways to plot this piece)
yr_of_int <- which(pH_dates$Year == RptYr - 1)
ann_mean_x12 <- rep(ann_mean_RptYr,length(yr_of_int))

# Separate most recent year from previous years
prev_yrs <- which(pH_dates$Year < RptYr - 1)
all_yrs <- which(pH_dates$Year <= RptYr)

# Create axes limit values, to make things simpler
pH_xlim <- c(min(mdy(pH_dates$`date mmddyy`)), max(mdy(pH_dates$`date mmddyy`)))
pH_ylim <- c(8.04, 8.13)

# Create color palette for easy reference 
oceans <- nmfspalette::nmfs_palette("oceans")(3) # 1 = RptYr, 3 = previous years
crustacean <- nmfspalette::nmfs_palette("crustacean")(4) # 1 = linear trend
coral <- nmfspalette::nmfs_palette("coral")(3) # 3 = annual average for Rpt Yr
ann_grey <- "#D0D0D0" # annual means; in NMFS branding guide but not in package
pal <- c(oceans[3], oceans[1], ann_grey, coral[3], crustacean[1])

# Plot
pdf(paste(Dir, '/Oceanic_pH_ts_', RptYr, '.pdf', sep = ""), width = 7, height = 4.5)
plot(make_date(ann_pH$Year, 6), ann_pH$pH, type = "l", lwd = 2, col = ann_grey,
     xlim = pH_xlim, ylim = pH_ylim, xlab = "Year", ylab = "pH",
     xaxt = "n", yaxt = "n", xaxs = "i", yaxs = "i")
par(new = TRUE)
plot(mdy(pH_dates$`date mmddyy`[all_yrs]), pH_lm_fit, type = "l", lwd = 2, col = crustacean[1], 
     xlim = pH_xlim, ylim = pH_ylim, xlab = " ", ylab = " ",
     xaxt = "n", yaxt = "n", xaxs = "i", yaxs = "i")
par(new = TRUE)
plot(mdy(pH_dates$`date mmddyy`[all_yrs]), pH_dates$pH[all_yrs], type = "l", lwd = 2, col = oceans[3], 
     xlim = pH_xlim, ylim = pH_ylim, xlab = " ", ylab = " ",
     xaxt = "n", yaxt = "n", xaxs = "i", yaxs = "i") 
par(new = TRUE)
plot(mdy(pH_dates$`date mmddyy`[yr_of_int]), pH_dates$pH[yr_of_int], type = "l", lwd = 2, col = oceans[1], 
     xlim = pH_xlim, ylim = pH_ylim, xlab = " ", ylab = " ", 
     xaxt = "n", yaxt = "n", xaxs = "i", yaxs = "i")
par(new = TRUE)
plot(mdy(pH_dates$`date mmddyy`[yr_of_int]), ann_mean_x12, type = "l", lwd = 2, col = coral[3], 
     xlim = pH_xlim, ylim = pH_ylim, xlab = " ", ylab = " ", 
     xaxt = "n", yaxt = "n", xaxs = "i", yaxs = "i")
axis((1), at = make_date(seq(1990, 2020, 5)), tck = 0.025, labels = year(make_date(seq(1990, 2020, 5))))
axis((2), at = seq(8.04, 8.13, 0.01), tck = 0.025, las = 1)
axis((3), at = make_date(seq(1990, 2020, 5)), tck = 0.025, labels = FALSE)
axis((4), at = seq(8.04, 8.13, 0.01), tck = 0.025, labels = FALSE)
legend(x = "bottomright", 
       legend = c(paste("Monthly average, 1989 - ", RptYr - 2, sep = ""), 
                  paste("Monthly average, ", RptYr - 1, sep = ""),
                  paste("Annual average, 1989 - ", RptYr - 2, sep = ""), 
                  paste("Annual average, ", RptYr - 1, sep = ""),
                  "Long-term trend"), 
       lty = 1, lwd = 2,
       col = pal, 
       bty = "n")
dev.off()
# _axt = "n" removes tick labels, _axs = "i" removes whitespace beyond axes maxima
# bty = "n" removes the box around the legend
```

```{r}
#| include: false
# Write csv for portal
# Note that output csvs go in their own folder
ann_pH <- rename(ann_pH, year = Year)
write_csv(ann_pH, file = paste(here(), '/PelagicClimate_', RptYr, '/pH_', RptYr, '.csv', sep = ""))
```

Rationale: Oceanic pH is a measure of how greenhouse gas emissions have already impacted the ocean. This indicator demonstrates that oceanic pH has decreased significantly over the past several decades (i.e., the ocean has become more acidic). Increasing ocean acidification limits the ability of marine organisms to build shells and other calcareous structures. Recent research has shown that pelagic organisms such as pteropods and other prey for commercially valuable fish species are already being negatively impacted by increasing acidification (Feely et al. 2016). The full impact of ocean acidification on the pelagic food web is an area of active research (Fabry et al. 2008).

Status: The ocean is roughly `r signif(delta_pH_pct, 3)`% more acidic than it was 30 years ago at the start of this time series. Over this time, pH has declined by `r abs(signif(delta_pH_lm, 2))` at a constant rate. In `r RptYr-1`, the most recent year for which data are available, the average pH was `r signif(ann_mean_RptYr, 3)`. Additionally, for the `r n_yrs_below`th year, small variations seen over the course of the year are outside the range seen in the first year of the time series. The highest pH value reported for the most recent year (`r signif(ann_max_RptYr, 4)`) is lower than the lowest pH value reported in the first year of the time series (`r signif(yr1_min, 4)`).

Description: Trends in surface (5 m) pH at Station ALOHA, north of Oahu (22.75°N, 158°W), collected by the Hawaiʻi Ocean Time Series (HOT) from October 1988 to `r RptYr - 1` (`r RptYr` data are not yet available). Oceanic pH is a measure of ocean acidity, which increases as the ocean absorbs carbon dioxide from the atmosphere. Lower pH values represent greater acidity. Oceanic pH is calculated from total alkalinity (TA) and dissolved inorganic carbon (DIC). Total alkalinity represents the ocean’s capacity to resist acidification as it absorbs CO~2~ and the amount of CO~2~ absorbed is captured through measurements of DIC. The multi-decadal time series at Station ALOHA represents the best available documentation of the significant downward trend in oceanic pH since the time series began in 1988. Oceanic pH varies over both time and space, though the conditions at Station ALOHA are considered broadly representative of those across the Western and Central Pacific’s pelagic fishing grounds.

Timeframe: Monthly.

Region/Location: Station ALOHA: 22.75°N, 158°W.

Measurement Platform: *In-situ* station.

Data available at: <https://hahana.soest.hawaii.edu/hot/hot-dogs/bseries.html>. 

Sourced from: Fabry et al. (2008), Feely et al. (2016), and the Hawaiʻi Ocean Time Series as described in Karl and Lukas (1996) and on its website (HOT 2023) using the methodology provided by Zeebe and Wolf-Gladrow (2001).

Graphics produced in part using Stawitz (2022).

## Additional Information

The following variables (listed as operators on the web interface) were downloaded from <https://hahana.soest.hawaii.edu/hot/hot-dogs/bseries.html>:

- Alkalinitiy
- Dissolved Inorganic Carbon

Other options on the web interface were set to:

- Years: blank to download all
- Station #: 2 (station ALOHA)
- Value/range: 5 (for 5 m depth)
- Function Grouping: Depth
- Function: Horizon
- Grouping: none
- Output type: text

Data were manually copied and pasted into .csvs.  In this process, the 2-line header was combined 
into a 1-line header.  These variables were then matched by date in `pH_prep.Rmd` and used to run 
csysUI.m with the default options, and a tab-delimited input file (TA_DIC_`r RptYr`):

- Temperature = 25 C (reasonable up until maybe the most recent year)
- Salinity = 35 (broadly reasonable)
- Pressure = 5 bar (because these values come from 5 m depth)
The output headers can be found here: 
<https://www.soest.hawaii.edu/oceanography/faculty/zeebe_files/CO2_System_in_Seawater/ReadMeUI.txt>

The resulting total pH values are in reasonable agreement with the calculated pH values that are 
available on HOT albeit with a large temporal gap.  The resulting total pH values (pH_`r RptYr`.dat) 
are used in this script.  The R + Matlab workflow is admittedly cumbersome and not an option 
for those without a Matlab license.  Please let me know if an R equivalent of csysUI.m exists.

A plot of the residuals from the linear model showed that they were evenly distributed between 
-0.03 and 0.03.
